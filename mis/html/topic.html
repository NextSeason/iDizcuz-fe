<!DOCTYPE html>
<html>
    <head>
        <?php $title = 'iDizcuz Management Information System'; ?>
        @Include::common::head.inc.html
        <link rel="stylesheet" type="text/css" href="@Static::css/mis.css" />
        <link rel="stylesheet" type="text/css" href="@Static::css/newTopic.css" />
    </head>
    <body>
        <div id="idizcuz">
            @Include::top.inc.html
            <div class="main">
                @Include::sidebar.inc.html
                <div class="core">
                    <?php if( !$topic ) { ?>
                        <p class="not-exists">Topic不存在</p>
                    <?php } else { ?>
                    <form class="topic-form" data-topic-id="<?php echo $topic['id']; ?>">
                        <label>
                            <p class="s-title">论点标题(120字字节，通常一个汉字占三个字节)：</p>
                            <input type="text" class="title" placeholder="论点标题" value="<?php echo $topic['title']; ?>" />
                        </label>
                        <div class="line clearfix">
                            <label>
                                <p class="s-title">类型：</p>
                                <div class="styled-select">
                                    <select class="type">
                                        <option value="0">讨论</option>
                                        <option value="1">辩论</option>
                                    </select>
                                </div>
                            </label>
                            <label>
                                <p class="s-title">分类：</p>
                                <div class="styled-select">
                                    <select class="cid">
                                        <option value="1">焦点话题</option>
                                    </select>
                                </div>
                            </label>
                            <label>
                                <p class="s-title">开始时间(无需自动发布则不添加时间)：</p>
                                <input type="date" class="start-date" />
                                <input type="time" class="start-time" />
                            </label>
                        </div>
                        <label>
                            <p class="s-title">话题介绍：</p>
                            <textarea class="desc"><?php echo $topic['desc']; ?></textarea>
                        </label>
                        <label>
                            <p class="s-title">话题事件列表：（键入事件ID，多个ID之间用逗号隔开）</p>
                            <input type="text" class="events" value="<?php echo $topic['events']; ?>" />
                        </label>
                        <div class="warn"></div>
                        <label>
                            <a href="###" class="btns large save">保存</a>
                        </label>
                    </form>
                    <?php } ?>
                </div>
            </div>
        </div>
        <script>
            ( function() {
                var showWarn = function( txt ) {
                    $( '.warn' ).html( txt ).show();
                };
                var submit = function( isPublic ) {
                    var title = $.trim( $('input.title' ).val() ),
                        byteLen = J.byteLen( title ),
                        desc,
                        data = {},
                        events;

                    if( !title.length ) {
                        showWarn( '没有填写标题' );
                        return false;
                    }

                    if( byteLen > 120 ) {
                        showWarn( '标题长度超出了' + ( byteLen - 120 ) + '字节' );
                        return false;
                    }

                    desc = $.trim( $( 'textarea.desc' ).val() );

                    if( !desc.length ) {
                        showWarn( '没有填写论点介绍' );
                        return false;
                    }

                    events = $.trim( $( 'input.events' ).val() );

                    events = events.replace( /，/g, ',' ).replace( /^,|,$/g, '' );

                    if( events.length && !/^[\d,]+$/.test( events ) ) {
                        showWarn( '话题事件列表格式不正确' );
                        return false;
                    }

                    $( '.warn' ).hide();

                    data = {
                        id : $( 'form.topic-form' ).attr( 'data-topic-id' ),
                        title : title,
                        desc : desc,
                        type : $( 'select.type' ).val(),
                        cid : $( 'select.cid' ).val(),
                    };

                    events && ( data.events = events );

                    isPublic && ( data.isPublic = 1 );

                    $.ajax( {
                        url : '/mis/interface/modifytopic',
                        method : 'POST',
                        data : data
                    } ).done( function( response ) {
                        var errno = +response.errno;

                        if( !errno ) {
                            alert( '修改成功' );
                            location.reload();
                        }
                    } );
                };

                $( '.save' ).on( 'click', function( e ) {
                    if( !window.confirm( '确认填写无误，直接发布？' ) ) {
                        return false;
                    }
                    submit( true );
                } );
            } )();
        </script>
    </body>
</html>
